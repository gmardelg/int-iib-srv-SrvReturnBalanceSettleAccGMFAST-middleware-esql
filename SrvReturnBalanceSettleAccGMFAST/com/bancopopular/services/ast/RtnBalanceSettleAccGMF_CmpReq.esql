BROKER SCHEMA com.bancopopular.services.ast


CREATE COMPUTE MODULE RtnBalanceSettleAccGMF_CmpReq
	CREATE FUNCTION Main() RETURNS BOOLEAN
	BEGIN
		/******************************************************/
		-- Copiar cabeceras de mensaje
		/******************************************************/
		SET OutputRoot.MQMD   = InputRoot.MQMD;
		SET OutputRoot.MQRFH2 = InputRoot.MQRFH2;
		
		/**********************/
		-- Declarar referencias
		/**********************/
		DECLARE refEnv REFERENCE TO Environment.Variables.headers;
		DECLARE refMQRFH2 REFERENCE TO OutputRoot.MQRFH2;
		DECLARE refInp REFERENCE TO InputRoot.XMLNSC;
		MOVE refInp LASTCHILD;
		MOVE refInp LASTCHILD;
		
		--Establece cabeceras para generar respuesta
		SET refEnv.MQMD   = InputRoot.MQMD;
		SET refEnv.MQRFH2 = InputRoot.MQRFH2;
		SET refEnv.MQRFH2.usr.log.idLog = '2';

		--Valores de mensaje request requeridos para Auditoria AST
		DECLARE rqUid		CHARACTER COALESCE(refMQRFH2.usr.transactionInfoRq.transactionId, refInp.*:RqUID);
		DECLARE channel		CHARACTER FIELDVALUE(refInp.*:MsgRqHdr.*:Channel);
		DECLARE userId		CHARACTER COALESCE(refInp.*:MsgRqHdr.*:UserId.*:GovIssueIdent.*:IdentSerialNum, '');
		DECLARE branchId	CHARACTER COALESCE(refInp.*:MsgRqHdr.*:BankInfo.*:BranchId, ZERO);
		DECLARE branchname	CHARACTER COALESCE(refInp.*:MsgRqHdr.*:BankInfo.*:Name, '');
		DECLARE ipAddr		CHARACTER COALESCE(refInp.*:MsgRqHdr.*:IPAddr, IP);
		DECLARE fechaTrx	CHARACTER FIELDVALUE(refInp.*:MsgRqHdr.*:ClientDt);

		--Auditoria en BD
		SET refMQRFH2.usr.log.idLog	= '2';
		CALL common.procedures.general.createMsgLogs(refMQRFH2, refMQRFH2.usr.log.idLog, 'WS');

		--Establece nombres de proveedor y aplicaci√≥n
		SET refMQRFH2.usr.log.nmProvider		= Provider;
		SET refMQRFH2.usr.log.nameApplication	= Service;

		--Crea contenedor Body
		CREATE FIELD OutputRoot.JSON.Data.body;
		DECLARE refOut REFERENCE TO OutputRoot.JSON.Data.body;
		
		MOVE refInp LASTCHILD;
 		SET refOut.codOficina	 = branchId;
		SET refOut.idRegistro	 = rqUid;
		SET refOut.nomOficina	 = branchname;
		SET refOut.usuario		 = userId;		

		--Crea contenedor trace
		CREATE FIELD OutputRoot.JSON.Data.trace;
		MOVE refOut TO OutputRoot.JSON.Data.trace;

		SET refOut.branchId		= branchId;
		SET refOut.channel  	= common.functions.global.cache.getDataHomologationCache(UBSCOMP,Canal,channel,HOMOLOGATION);
		SET refOut.ipAddr		= ipAddr;
		SET refOut.reverse		= false;
		SET refOut.rqUID		= rqUid;
		SET refOut.userId		= userId;
		SET refOut.workingDay  	= app.fecha;
		--Envia mensaje de Auditoria
		PROPAGATE TO TERMINAL 'out1' DELETE NONE;

		--Se anulan las cabeceras MQMD y MQRFH2 para que solo viaje al Request lo requerido por el back-end 		
		SET OutputRoot.MQMD 	= NULL;
		SET OutputRoot.MQRFH2 	= NULL;
		--Establecer Endpoint y Timeout para consumir WS
		SET OutputLocalEnvironment.Destination.REST.Request.BaseURL = refMQRFH2.usr.service.baseURL;
		SET OutputLocalEnvironment.Destination.REST.Request.Timeout = CAST(refMQRFH2.usr.service.timeOut AS INTEGER);

		--Invoca WS
		RETURN TRUE;
	END;
END MODULE;
